i= 2
## MCMC Move
mu.update = array(rnorm(n*2,0,.1),c(n,2))
mu.tmp = mu[,i-1,]+mu.update
lambda.update = array(rlnorm(n*2,0,.1),c(n,2))
?var
t = 50##dimension
n = 500##number of particles
N = 1e6
m = 200##first parallel to yield mse
p = 192## parallel experiments
alpha=0.91
sigma=1.0
beta=0.5
W=rep(1,n)/n
threshold = seq(.1,1,by=0.1)
x = rep(0,t)
y = rep(0,t)
X = matrix(rep(0,n*t),nrow=n)
X0 = matrix(rep(0,N*t),nrow=N)
x.estimate.ss = array(rep(0,t*m*length(threshold)),c(m,t,length(threshold)))
x.estimate.ori = rep(0,t)
set.seed(l)
##Generate Samples
v = rnorm(t)
u = rnorm(t)
x[1] = rnorm(1,0,sigma^2/(1-alpha^2))
y[1] = beta*exp(x[1]/2)*u[1]
for (i in 2:t){
x[i] = alpha*x[i-1]+sigma*v[i]
y[i] = beta*exp(x[i]/2)*u[i]
}
j = 1
X[,1] = rnorm(n)
W = dnorm(X[,1],0,sigma^2/(1-alpha^2))*dnorm(y[i],0,beta*exp(X[,i]/2))/dnorm(X[,1])
if (any(is.na(W))){
idx = is.na(W)
W[idx] = 0
}
w = W/sum(W)
x.estimate.ss[l,1,j] = sum(w*X[,1])
l = 1
x.estimate.ss[l,1,j] = sum(w*X[,1])
if (1/sum(w^2) < threshold[j]*n){
idx = sample(1:n,n,prob = w, replace = T)
X = X[idx,]
W = rep(1/n,n)
}
for (i in 2:t) {
X[,i]=rnorm(n,X[,i-1]+y[i])
lW.tmp = log(dnorm(X[,i],alpha*X[,i-1],sigma^2))+log(dnorm(y[i],0,beta*exp(X[,i]/2)))-log(dnorm(X[,i],X[,i-1]+y[i]))
if (all(lW.tmp<log(1e-200))){
lW.tmp = lW.tmp + log(1e300)
}
if (all(exp(lW.tmp)==0)){
cat("i=",i)
}
W = W*exp(lW.tmp)
if (all(W<1e-50)){
W = W*1e100
}
if (any(is.na(W))){
idx = is.na(W)
W[idx] = 0
}
w = W/sum(W)
x.estimate.ss[l,i,j] = sum(w*X[,i])
if (1/sum(w^2)<threshold[j]*n){
idx = sample(1:n,n,prob = w, replace = T)
X = X[idx,]
W = rep(1/n,n)
}
}
W
plot(x)
l = 2
##Generate Samples
v = rnorm(t)
u = rnorm(t)
x[1] = rnorm(1,0,sigma^2/(1-alpha^2))
y[1] = beta*exp(x[1]/2)*u[1]
for (i in 2:t){
x[i] = alpha*x[i-1]+sigma*v[i]
y[i] = beta*exp(x[i]/2)*u[i]
}
X[,1] = rnorm(n)
W = dnorm(X[,1],0,sigma^2/(1-alpha^2))*dnorm(y[i],0,beta*exp(X[,i]/2))/dnorm(X[,1])
if (any(is.na(W))){
idx = is.na(W)
W[idx] = 0
}
w = W/sum(W)
x.estimate.ss[l,1,j] = sum(w*X[,1])
if (1/sum(w^2) < threshold[j]*n){
idx = sample(1:n,n,prob = w, replace = T)
X = X[idx,]
W = rep(1/n,n)
}
for (i in 2:t) {
X[,i]=rnorm(n,X[,i-1]+y[i])
lW.tmp = log(dnorm(X[,i],alpha*X[,i-1],sigma^2))+log(dnorm(y[i],0,beta*exp(X[,i]/2)))-log(dnorm(X[,i],X[,i-1]+y[i]))
if (all(lW.tmp<log(1e-200))){
lW.tmp = lW.tmp + log(1e300)
}
if (all(exp(lW.tmp)==0)){
cat("i=",i)
}
W = W*exp(lW.tmp)
if (all(W<1e-50)){
W = W*1e100
}
if (any(is.na(W))){
idx = is.na(W)
W[idx] = 0
}
w = W/sum(W)
x.estimate.ss[l,i,j] = sum(w*X[,i])
if (1/sum(w^2)<threshold[j]*n){
idx = sample(1:n,n,prob = w, replace = T)
X = X[idx,]
W = rep(1/n,n)
}
}
plot(x.estimate.ss[2,,])
plot(x.estimate.ss[2,,1])
l = 3
##Generate Samples
v = rnorm(t)
u = rnorm(t)
x[1] = rnorm(1,0,sigma^2/(1-alpha^2))
y[1] = beta*exp(x[1]/2)*u[1]
for (i in 2:t){
x[i] = alpha*x[i-1]+sigma*v[i]
y[i] = beta*exp(x[i]/2)*u[i]
}
X[,1] = rnorm(n)
W = dnorm(X[,1],0,sigma^2/(1-alpha^2))*dnorm(y[i],0,beta*exp(X[,i]/2))/dnorm(X[,1])
if (any(is.na(W))){
idx = is.na(W)
W[idx] = 0
}
w = W/sum(W)
x.estimate.ss[l,1,j] = sum(w*X[,1])
if (1/sum(w^2) < threshold[j]*n){
idx = sample(1:n,n,prob = w, replace = T)
X = X[idx,]
W = rep(1/n,n)
}
for (i in 2:t) {
X[,i]=rnorm(n,X[,i-1]+y[i])
lW.tmp = log(dnorm(X[,i],alpha*X[,i-1],sigma^2))+log(dnorm(y[i],0,beta*exp(X[,i]/2)))-log(dnorm(X[,i],X[,i-1]+y[i]))
if (all(lW.tmp<log(1e-200))){
lW.tmp = lW.tmp + log(1e300)
}
if (all(exp(lW.tmp)==0)){
cat("i=",i)
}
W = W*exp(lW.tmp)
if (all(W<1e-50)){
W = W*1e100
}
if (any(is.na(W))){
idx = is.na(W)
W[idx] = 0
}
w = W/sum(W)
x.estimate.ss[l,i,j] = sum(w*X[,i])
if (1/sum(w^2)<threshold[j]*n){
idx = sample(1:n,n,prob = w, replace = T)
X = X[idx,]
W = rep(1/n,n)
}
}
l = 4
set.seed(l)
##Generate Samples
v = rnorm(t)
u = rnorm(t)
x[1] = rnorm(1,0,sigma^2/(1-alpha^2))
y[1] = beta*exp(x[1]/2)*u[1]
for (i in 2:t){
x[i] = alpha*x[i-1]+sigma*v[i]
y[i] = beta*exp(x[i]/2)*u[i]
}
X[,1] = rnorm(n)
W = dnorm(X[,1],0,sigma^2/(1-alpha^2))*dnorm(y[i],0,beta*exp(X[,i]/2))/dnorm(X[,1])
if (any(is.na(W))){
idx = is.na(W)
W[idx] = 0
}
w = W/sum(W)
x.estimate.ss[l,1,j] = sum(w*X[,1])
if (1/sum(w^2) < threshold[j]*n){
idx = sample(1:n,n,prob = w, replace = T)
X = X[idx,]
W = rep(1/n,n)
}
for (i in 2:t) {
X[,i]=rnorm(n,X[,i-1]+y[i])
lW.tmp = log(dnorm(X[,i],alpha*X[,i-1],sigma^2))+log(dnorm(y[i],0,beta*exp(X[,i]/2)))-log(dnorm(X[,i],X[,i-1]+y[i]))
if (all(lW.tmp<log(1e-200))){
lW.tmp = lW.tmp + log(1e300)
}
if (all(exp(lW.tmp)==0)){
cat("i=",i)
}
W = W*exp(lW.tmp)
if (all(W<1e-50)){
W = W*1e100
}
if (any(is.na(W))){
idx = is.na(W)
W[idx] = 0
}
w = W/sum(W)
x.estimate.ss[l,i,j] = sum(w*X[,i])
if (1/sum(w^2)<threshold[j]*n){
idx = sample(1:n,n,prob = w, replace = T)
X = X[idx,]
W = rep(1/n,n)
}
}
#-*- coding:utf-8 -*-
library(parallel)
library(foreach)
library(doSNOW)
numCores = detectCores()
cl = makeCluster(numCores)
registerDoSNOW(cl)
m = 192
## doSNOW progress bar
pb = txtProgressBar(max = m,style=3)
progress = function(n) setTxtProgressBar(pb,n)
opts = list(progress=progress)
##INITIAL VALUES
t = 50##dimension
n = 500##number of particles
m = 200##first parallel to yield mse
p = 48## parallel experiments
alpha=0.91
sigma=1.0
beta=0.5
W=rep(1,n)/n
threshold = seq(.1,1,by=0.1)
doit <- function(l){
x = rep(0,t)
y = rep(0,t)
X = matrix(rep(0,n*t),nrow=n)
X0 = matrix(rep(0,N*t),nrow=N)
x.estimate.ss = array(rep(0,t*m*length(threshold)),c(m,t,length(threshold)))
x.estimate.ori = rep(0,t)
set.seed(l)
##Generate Samples
v = rnorm(t)
u = rnorm(t)
x[1] = rnorm(1,0,sigma^2/(1-alpha^2))
y[1] = beta*exp(x[1]/2)*u[1]
for (i in 2:t){
x[i] = alpha*x[i-1]+sigma*v[i]
y[i] = beta*exp(x[i]/2)*u[i]
}
for (l in 1:m) {
for (j in 1:length(threshold)){#change of series
X[,1] = rnorm(n)
W = dnorm(X[,1],0,sigma^2/(1-alpha^2))*dnorm(y[i],0,beta*exp(X[,i]/2))/dnorm(X[,1])
if (any(is.na(W))){
idx = is.na(W)
W[idx] = 0
}
w = W/sum(W)
x.estimate.ss[l,1,j] = sum(w*X[,1])
if (1/sum(w^2) < threshold[j]*n){
idx = sample(1:n,n,prob = w, replace = T)
X = X[idx,]
W = rep(1/n,n)
}
for (i in 2:t) {
X[,i]=rnorm(n,X[,i-1]+y[i])
lW.tmp = log(dnorm(X[,i],alpha*X[,i-1],sigma^2))+log(dnorm(y[i],0,beta*exp(X[,i]/2)))-log(dnorm(X[,i],X[,i-1]+y[i]))
if (all(lW.tmp<log(1e-200))){
lW.tmp = lW.tmp + log(1e300)
}
if (all(exp(lW.tmp)==0)){
cat("i=",i)
}
W = W*exp(lW.tmp)
if (all(W<1e-50)){
W = W*1e100
}
if (any(is.na(W))){
idx = is.na(W)
W[idx] = 0
}
w = W/sum(W)
x.estimate.ss[l,i,j] = sum(w*X[,i])
if (1/sum(w^2)<threshold[j]*n){
idx = sample(1:n,n,prob = w, replace = T)
X = X[idx,]
W = rep(1/n,n)
}
}
}
}
mse.ss <- matrix(rep(0,length(threshold)*t),nrow=length(threshold))
for (k in 1:length(threshold)){
for (i in 1:m)
{
mse.ss[k,] = mse.ss[k,]+(x-x.estimate.ss[i,,k])^2
}
}
mse.ss = mse.ss/m
mse.sum.ss <- rowSums(mse.ss)
return(list(mse = mse.sum.ss, x.estimate=x.estimate.ss, x=x))
}
res = foreach (l = 1:p,.combine = rbind,.packages = "Boom",
.options.snow=opts) %dopar% {
return(doit(l))
}
gc()
gc()
gc()
infty
inf
+inf
Inf
-Inf
0>-Inf
is.na(Inf)
is.infinite(Inf)
is.infinite(0)
log(1e200)
log(1e-200)
1e-312
-Inf+200
#-*- coding: utf-8 -*-
n_dim = 20
n_particles = 500
m = 480
threshold = seq(0.1,1,by=0.1)
library(mvtnorm)
## density
ldens = function(t,x){
dens = 0.5*dmvnorm(x[1:t],3*rep(1,t),diag(rep(1,t)))+0.5*dmvnorm(x[1:t],-3*rep(1,t),diag(rep(1,t)))
return(log(dens))
}
set.seed(l)
X = array(rep(0,n_particles*n_dim*length(threshold)),c(n_particles,n_dim,length(threshold)))
rejuvs = rep(0,length(threshold))
x.estimate = matrix(rep(0,n_dim*length(threshold)),nrow=length(threshold))
for (j in 1:length(threshold)) {
X[,1,j] = rnorm(n_particles,0,3)
W = exp(apply(X[,,j], 2, ldens,t=1)-log(dnorm(X[,1,j],0,3)))
w = W/sum(W)
if (1/sum(w^2) < threshold[j]*n_particles){
idx = sample(1:n_particles,n_particles,prob=w,replace=T)
X = X[idx,,]
W = rep(1/n_particles,n_particles)
rejuvs[j] = rejuvs[j]+1
}
for (i in 2:n_dim) {
X[,i,j] = rnorm(n_particles,0,3)
W = exp(log(W)+apply(X[,,j], 2, ldens,t=i)-log(dnorm(X[,i,j],0,3)))
w = W/sum(W)
if (1/sum(w^2) < threshold[j]*n_particles){
idx = sample(1:n_particles,n_particles,prob=w,replace=T)
X = X[idx,,]
W = rep(1/n_particles,n_particles)
rejuvs[j] = rejuvs[j] + 1
}
}
x.estimate[j,] = as.vector(w%*%X[,,j])
}
plot(X[,1,10],X[,2,10])
plot(X[,19,10],X[,20,10])
plot(X[,20,10])
plot(X[,20,1])
plot(X[,19,1])
plot(X[1,,1])
apply(X[,,10], 2, ldens,t=20)[1]
ldens(20,X[1,,10])
ldens(20,X[,1,10])
apply(X[,,10], 1, ldens,t=20)[1]
set.seed(l)
X = array(rep(0,n_particles*n_dim*length(threshold)),c(n_particles,n_dim,length(threshold)))
rejuvs = rep(0,length(threshold))
x.estimate = matrix(rep(0,n_dim*length(threshold)),nrow=length(threshold))
for (j in 1:length(threshold)) {
X[,1,j] = rnorm(n_particles,0,3)
W = exp(apply(X[,,j], 1, ldens,t=1)-log(dnorm(X[,1,j],0,3)))
w = W/sum(W)
if (1/sum(w^2) < threshold[j]*n_particles){
idx = sample(1:n_particles,n_particles,prob=w,replace=T)
X = X[idx,,]
W = rep(1/n_particles,n_particles)
rejuvs[j] = rejuvs[j]+1
}
for (i in 2:n_dim) {
X[,i,j] = rnorm(n_particles,0,3)
W = exp(log(W)+apply(X[,,j], 1, ldens,t=i)-log(dnorm(X[,i,j],0,3)))
w = W/sum(W)
if (1/sum(w^2) < threshold[j]*n_particles){
idx = sample(1:n_particles,n_particles,prob=w,replace=T)
X = X[idx,,]
W = rep(1/n_particles,n_particles)
rejuvs[j] = rejuvs[j] + 1
}
}
w = W/sum(W)
x.estimate[j,] = as.vector(w%*%X[,,j])
}
plot(X[,20,10])
plot(X[,19,10],X[,20,10])
plot(X[,1,10],X[,2,10])
X = array(rep(0,n_particles*n_dim*length(threshold)),c(n_particles,n_dim,length(threshold)))
rejuvs = rep(0,length(threshold))
x.estimate = matrix(rep(0,n_dim*length(threshold)),nrow=length(threshold))
for (j in 1:length(threshold)) {
X[,1,j] = rnorm(n_particles,0,3)
W = exp(apply(X[,,j], 1, ldens,t=1)-log(dnorm(X[,1,j],0,3)))
w = W/sum(W)
if (1/sum(w^2) < threshold[j]*n_particles){
idx = sample(1:n_particles,n_particles,prob=w,replace=T)
X = X[idx,,]
W = rep(1/n_particles,n_particles)
rejuvs[j] = rejuvs[j]+1
}
for (i in 2:n_dim) {
X[,i,j] = rnorm(n_particles,0,3)
W = exp(log(W)+apply(X[,,j], 1, ldens,t=i)-log(dnorm(X[,i,j],0,3)))
w = W/sum(W)
if (1/sum(w^2) < threshold[j]*n_particles){
idx = sample(1:n_particles,n_particles,prob=w,replace=T)
X = X[idx,,]
W = rep(1/n_particles,n_particles)
rejuvs[j] = rejuvs[j] + 1
}
}
w = W/sum(W)
x.estimate[j,] = as.vector(w%*%X[,,j])
}
plot(X[,1,10],X[,2,10])
plot(X[,19,10],X[,20,10])
setwd("C:/Users/xuzhi/smcresampfreq/GMG")
load("GMGM.RData")
X = array(rep(0,m*n_dim*length(threshold)),c(m,n_dim,length(threshold)))
rejuvs = matrix(rep(0,m*length(threshold)),nrow=m)
X = array(rep(0,m*n_dim*length(threshold)),c(m,n_dim,length(threshold)))
rejuvs = matrix(rep(0,m*length(threshold)),nrow=m)
for (i in 1:m){
X[i,,] = t(res[i,]$estimate)
rejuvs[i,] = res[i,]$rejuvs
}
mse = rep(0,length(threshold))
for (j in 1:length(threshold)) {
mse[j] = sum(X[,,j]^2)
}
mse = mse/m
plot(mse)
plot(X[,19,10],X[,20,10])
plot(X[,1,10],X[,2,10])
plot(X[,1,1],X[,2,1])
plot(X[,19,1],X[,20,1])
setwd("C:/Users/xuzhi/smcresampfreq/HD")
load("HDS.RData")
head(res)
str(res[1,]$estimate)
X = array(rep(0,m*p*length(threshold)),c(m,p,length(threshold)))
rejuvs = matrix(rep(0,m*length(threshold)),nrow = m)
for (i in 1:m) {
X[i,,] = res[i,]$estimate
rejuvs[i,] = res[i,]$rejuvs
}
colMeans(rejuvs)
mse = rep(0,length(threshold))
for (j in 1:length(threshold)) {
mse[j] = sum(X[,,j]^2)
}
mse = mse/m
plot(mse)
load("HDM.RData")
X = array(rep(0,m*p*length(threshold)),c(m,p,length(threshold)))
rejuvs = matrix(rep(0,m*length(threshold)),nrow = m)
for (i in 1:m) {
X[i,,] = res[i,]$estimate
rejuvs[i,] = res[i,]$rejuvs
}
colMeans(rejuvs)
mse = rep(0,length(threshold))
for (j in 1:length(threshold)) {
mse[j] = sum(X[,,j]^2)
}
mse = mse/m
plot(mse)
boxplot(X[,,j])
boxplot(X[,,j-1])
boxplot(X[,,j-3])
boxplot(X[,,5])
setwd("C:/Users/xuzhi/smcresampfreq/GMG")
load("GMGM.RData")
X = array(rep(0,m*n_dim*length(threshold)),c(m,n_dim,length(threshold)))
rejuvs = matrix(rep(0,m*length(threshold)),nrow=m)
for (i in 1:m){
X[i,,] = t(res[i,]$estimate)
rejuvs[i,] = res[i,]$rejuvs
}
colMeans(rejuvs)
mse = rep(0,length(threshold))
for (j in 1:length(threshold)) {
mse[j] = sum(X[,,j]^2)
}
mse = mse/m
plot(mse)
